{
  "name": "deny-network-private-ips",
  "properties": {
    "description": "This policy denies the creation of network resources that use public IP addresses. It ensures that only private IP addresses are used for network interfaces, virtual machines, load balancers, and other network resources to maintain security and compliance with private network requirements.",
    "displayName": "Deny Network Resources with Public IP Addresses",
    "metadata": {
      "category": "Network",
      "source": "Azure Policy Testing Project",
      "version": "1.0.0"
    },
    "mode": "All",
    "parameters": {
      "effect": {
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "description": "The effect determines what happens when the policy rule is evaluated to match",
          "displayName": "Effect"
        },
        "type": "String"
      },
      "exemptedResourceNames": {
        "defaultValue": [
          "AzureFirewallManagementPublicIP",
          "GatewayPublicIP",
          "BastionPublicIP"
        ],
        "metadata": {
          "description": "List of resource names that are exempt from this policy (e.g., management resources, gateways)",
          "displayName": "Exempted Resource Names"
        },
        "type": "Array"
      }
    },
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/publicIPAddresses",
                "field": "type"
              },
              {
                "not": {
                  "field": "name",
                  "in": "[parameters('exemptedResourceNames')]"
                }
              }
            ]
          },
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/networkInterfaces",
                "field": "type"
              },
              {
                "count": {
                  "field": "Microsoft.Network/networkInterfaces/ipConfigurations[*]",
                  "where": {
                    "exists": "true",
                    "field": "Microsoft.Network/networkInterfaces/ipConfigurations[*].publicIPAddress.id"
                  }
                },
                "greater": 0
              }
            ]
          },
          {
            "allOf": [
              {
                "equals": "Microsoft.Compute/virtualMachines",
                "field": "type"
              },
              {
                "count": {
                  "field": "Microsoft.Compute/virtualMachines/networkProfile.networkInterfaces[*]",
                  "where": {
                    "anyOf": [
                      {
                        "exists": "true",
                        "field": "Microsoft.Compute/virtualMachines/networkProfile.networkInterfaces[*].properties.ipConfigurations[*].publicIPAddress"
                      },
                      {
                        "equals": "true",
                        "field": "Microsoft.Compute/virtualMachines/networkProfile.networkInterfaces[*].properties.enableIPForwarding"
                      }
                    ]
                  }
                },
                "greater": 0
              }
            ]
          },
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/loadBalancers",
                "field": "type"
              },
              {
                "count": {
                  "field": "Microsoft.Network/loadBalancers/frontendIPConfigurations[*]",
                  "where": {
                    "exists": "true",
                    "field": "Microsoft.Network/loadBalancers/frontendIPConfigurations[*].publicIPAddress.id"
                  }
                },
                "greater": 0
              }
            ]
          },
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/applicationGateways",
                "field": "type"
              },
              {
                "count": {
                  "field": "Microsoft.Network/applicationGateways/frontendIPConfigurations[*]",
                  "where": {
                    "exists": "true",
                    "field": "Microsoft.Network/applicationGateways/frontendIPConfigurations[*].publicIPAddress.id"
                  }
                },
                "greater": 0
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[parameters('effect')]"
      }
    },
    "policyType": "Custom"
  }
}
