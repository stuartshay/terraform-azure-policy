{
  "name": "deny-network-no-nsg",
  "properties": {
    "description": "This policy denies the creation of network resources (subnets and network interfaces) that do not have Network Security Groups (NSGs) associated. NSGs are required for network security and access control.",
    "displayName": "Deny Network Resources Without NSG",
    "metadata": {
      "category": "Network",
      "source": "Azure Policy Testing Project",
      "version": "1.0.0"
    },
    "mode": "All",
    "parameters": {
      "effect": {
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "description": "The effect determines what happens when the policy rule is evaluated to match",
          "displayName": "Effect"
        },
        "type": "String"
      },
      "exemptedSubnets": {
        "defaultValue": [
          "GatewaySubnet",
          "AzureFirewallSubnet",
          "AzureBastionSubnet",
          "RouteServerSubnet"
        ],
        "metadata": {
          "description": "List of subnet names that are exempt from this policy (e.g., GatewaySubnet, AzureFirewallSubnet)",
          "displayName": "Exempted Subnets"
        },
        "type": "Array"
      }
    },
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/virtualNetworks/subnets",
                "field": "type"
              },
              {
                "not": {
                  "field": "name",
                  "in": "[parameters('exemptedSubnets')]"
                }
              },
              {
                "anyOf": [
                  {
                    "exists": "false",
                    "field": "Microsoft.Network/virtualNetworks/subnets/networkSecurityGroup.id"
                  },
                  {
                    "equals": "",
                    "field": "Microsoft.Network/virtualNetworks/subnets/networkSecurityGroup.id"
                  }
                ]
              }
            ]
          },
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/networkInterfaces",
                "field": "type"
              },
              {
                "anyOf": [
                  {
                    "exists": "false",
                    "field": "Microsoft.Network/networkInterfaces/networkSecurityGroup.id"
                  },
                  {
                    "equals": "",
                    "field": "Microsoft.Network/networkInterfaces/networkSecurityGroup.id"
                  }
                ]
              },
              {
                "count": {
                  "field": "Microsoft.Network/networkInterfaces/ipConfigurations[*]",
                  "where": {
                    "anyOf": [
                      {
                        "exists": "false",
                        "field": "Microsoft.Network/networkInterfaces/ipConfigurations[*].subnet.networkSecurityGroup.id"
                      },
                      {
                        "equals": "",
                        "field": "Microsoft.Network/networkInterfaces/ipConfigurations[*].subnet.networkSecurityGroup.id"
                      }
                    ]
                  }
                },
                "greater": 0
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[parameters('effect')]"
      }
    },
    "policyType": "Custom"
  }
}
