{
  "name": "deny-function-app-anonymous",
  "properties": {
    "description": "This policy audits Azure Function Apps that do not have authentication enabled. Function Apps should require authentication to ensure security and protect sensitive code and data. This policy checks the authentication configuration (siteAuthEnabled) on the Function App's config resource.",
    "displayName": "Audit Function App Anonymous Access",
    "metadata": {
      "category": "Function App",
      "source": "Azure Policy Testing Project",
      "version": "2.0.0"
    },
    "mode": "Indexed",
    "parameters": {
      "effect": {
        "allowedValues": [
          "AuditIfNotExists",
          "Disabled"
        ],
        "defaultValue": "AuditIfNotExists",
        "metadata": {
          "description": "Enable or disable the execution of the policy",
          "displayName": "Effect"
        },
        "type": "String"
      },
      "exemptedFunctionApps": {
        "defaultValue": [],
        "metadata": {
          "description": "List of Function App names that are exempt from this policy",
          "displayName": "Exempted Function Apps"
        },
        "type": "Array"
      },
      "exemptedResourceGroups": {
        "defaultValue": [],
        "metadata": {
          "description": "List of resource group names that are exempt from this policy",
          "displayName": "Exempted Resource Groups"
        },
        "type": "Array"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "equals": "Microsoft.Web/sites",
            "field": "type"
          },
          {
            "contains": "functionapp",
            "field": "kind"
          },
          {
            "field": "kind",
            "notContains": "workflowapp"
          },
          {
            "not": {
              "field": "name",
              "in": "[parameters('exemptedFunctionApps')]"
            }
          },
          {
            "not": {
              "field": "Microsoft.Web/sites/resourceGroup",
              "in": "[parameters('exemptedResourceGroups')]"
            }
          }
        ]
      },
      "then": {
        "details": {
          "existenceCondition": {
            "equals": "true",
            "field": "Microsoft.Web/sites/config/siteAuthEnabled"
          },
          "name": "web",
          "type": "Microsoft.Web/sites/config"
        },
        "effect": "[parameters('effect')]"
      }
    },
    "policyType": "Custom"
  }
}
