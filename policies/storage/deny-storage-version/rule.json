{
   "name": "deny-storage-version",
   "properties": {
      "description": "This policy denies the creation of Azure Storage accounts that have blob versioning disabled. Blob versioning should be enabled for data protection, compliance, and recovery purposes.",
      "displayName": "Deny Storage Account Blob Versioning Disabled",
      "metadata": {
         "category": "Storage",
         "source": "Azure Policy Testing Project",
         "version": "1.0.0"
      },
      "mode": "All",
      "parameters": {
         "effect": {
            "allowedValues": [
               "Audit",
               "Deny",
               "Disabled"
            ],
            "defaultValue": "Deny",
            "metadata": {
               "description": "The effect determines what happens when the policy rule is evaluated to match",
               "displayName": "Effect"
            },
            "type": "String"
         },
         "storageAccountTypes": {
            "allowedValues": [
               "Standard_LRS",
               "Standard_GRS",
               "Standard_RAGRS",
               "Standard_ZRS",
               "Premium_LRS",
               "Premium_ZRS",
               "Standard_GZRS",
               "Standard_RAGZRS"
            ],
            "defaultValue": [
               "Standard_LRS",
               "Standard_GRS",
               "Standard_RAGRS",
               "Standard_ZRS",
               "Standard_GZRS",
               "Standard_RAGZRS"
            ],
            "metadata": {
               "description": "List of storage account types that require blob versioning",
               "displayName": "Storage Account Types"
            },
            "type": "Array"
         },
         "exemptedStorageAccounts": {
            "defaultValue": [],
            "metadata": {
               "description": "List of storage account names that are exempt from this policy",
               "displayName": "Exempted Storage Accounts"
            },
            "type": "Array"
         }
      },
      "policyRule": {
         "if": {
            "allOf": [
               {
                  "equals": "Microsoft.Storage/storageAccounts",
                  "field": "type"
               },
               {
                  "field": "Microsoft.Storage/storageAccounts/sku.name",
                  "in": "[parameters('storageAccountTypes')]"
               },
               {
                  "not": {
                     "field": "name",
                     "in": "[parameters('exemptedStorageAccounts')]"
                  }
               },
               {
                  "anyOf": [
                     {
                        "field": "Microsoft.Storage/storageAccounts/blobServices/isVersioningEnabled",
                        "exists": "false"
                     },
                     {
                        "field": "Microsoft.Storage/storageAccounts/blobServices/isVersioningEnabled",
                        "equals": "false"
                     }
                  ]
               }
            ]
         },
         "then": {
            "effect": "[parameters('effect')]"
         }
      },
      "policyType": "Custom"
   }
}